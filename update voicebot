import streamlit as st
import pandas as pd
from sqlalchemy import create_engine, text
from openai import OpenAI
from datetime import datetime
import pytz
import re
from typing import Optional, Dict, List
import base64
import tempfile
import os

# -----------------------------
# TRANSLATIONS DICTIONARY
# -----------------------------
TRANSLATIONS = {
    "English": {
        # Header
        "page_title": "Hajj Chatbot",
        "main_title": "Hajj Data Intelligence",
        "subtitle": "Ask anything about Hajj companies worldwide ‚Ä¢ AI-powered ‚Ä¢ Real-time data",
        
        # Sidebar
        "assistant_title": "üïã Hajj Assistant",
        "assistant_subtitle": "Your AI-powered guide",
        "language_title": "üåê language",
        "stats_title": "üìä Live Statistics",
        "examples_title": "üí° Quick Examples",
        "clear_chat": "üßπ Clear Chat History",
        "features_title": "‚ÑπÔ∏è Features",
        
        # Stats
        "total_agencies": "Total Agencies",
        "authorized": "Authorized",
        "countries": "Countries",
        "cities": "Cities",
        
        # Examples
        "ex_all_auth": "üîç All authorized companies",
        "ex_all_auth_q": "Show me all authorized Hajj companies",
        "ex_saudi": "üá∏üá¶ Companies in Saudi Arabia",
        "ex_saudi_q": "List companies in Saudi Arabia",
        "ex_by_country": "üìä Agencies by country",
        "ex_by_country_q": "How many agencies are in each country?",
        "ex_emails": "üìß Companies with emails",
        "ex_emails_q": "Find companies with email addresses",
        
        # Features
        "feat_ai": "AI-Powered Search",
        "feat_ai_desc": "Natural language queries",
        "feat_multilingual": "Multilingual",
        "feat_multilingual_desc": "Arabic & English support",
        "feat_viz": "Data Visualization",
        "feat_viz_desc": "Interactive tables",
        "feat_export": "Export Results",
        "feat_export_desc": "Download as CSV",
        "feat_secure": "Secure",
        "feat_secure_desc": "SQL injection protection",
        
        # Chat
        "welcome_msg": "Welcome! üëã\n\nI'm your Hajj Data Assistant. Ask me anything about Hajj companies, locations, or authorization status!",
        "input_placeholder": "Ask your question here... üí¨",
        "thinking": "ü§î Analyzing your question...",
        "searching": "üîç Searching database...",
        "generating_sql": "üß† Generating SQL query...",
        "executing_query": "üíæ Executing query...",
        "found_results": "‚úÖ Found {count} results",
        "sql_generated": "‚úÖ SQL query generated",
        "query_failed": "‚ùå Query failed",
        
        # Results
        "results_badge": "üìä {count} Results",
        "columns_badge": "‚úÖ {count} Columns",
        "authorized_badge": "üîí {count} Authorized",
        "download_csv": "üì• Download Results (CSV)",
        "view_sql": "üîç View SQL Query",
        "executed_caption": "Executed in database ‚Ä¢ {count} rows returned",
        
        # Messages
        "greeting": "Hello! üëã\n\nI'm doing great, thank you! I'm here to help you find information about Hajj companies. What would you like to know?",
        "no_results": "No results found. Try rephrasing the question or broadening the search.",
        "sql_error": "A database error occurred. Try rephrasing your question.",
        "intent_error": "‚ö†Ô∏è Intent detection issue",
        "general_error": "Sorry, I encountered an error.",
        "hint_rephrase": "üí° Try rephrasing your question or use different keywords",
        "no_sql": "Sorry, I couldn't convert that to a safe SQL query. Try rephrasing or ask for general results.",
        
        # Voice
        "voice_title": "üé§ Voice Assistant",
        "voice_instructions": "Click the microphone and speak your question",
        "voice_listening": "üé§ Listening... Speak now",
        "voice_processing": "üîÑ Processing your voice...",
        "voice_success": "‚úÖ Voice converted to text",
        "voice_error": "‚ùå Voice recognition failed",
        "voice_start": "üé§ Start Recording",
        "voice_stop": "‚èπÔ∏è Stop Recording",
        "voice_back": "üìù Back to Text Chat",
    },
    "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©": {
        # Header
        "page_title": "ÿ±Ÿàÿ®Ÿàÿ™ ÿßŸÑÿ≠ÿ¨",
        "main_title": "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ¨ ÿßŸÑÿ∞ŸÉŸäÿ©",
        "subtitle": "ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑÿ≠ÿ¨ ÿ≠ŸàŸÑ ÿßŸÑÿπÿßŸÑŸÖ ‚Ä¢ ŸÖÿØÿπŸàŸÖ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ‚Ä¢ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸàÿ±Ÿäÿ©",
        
        # Sidebar
        "assistant_title": "üïã ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ≠ÿ¨",
        "assistant_subtitle": "ÿØŸÑŸäŸÑŸÉ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿØÿπŸàŸÖ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
        "language_title": "üåê ÿßŸÑŸÑÿ∫ÿ©",
        "stats_title": "üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©",
        "examples_title": "üí° ÿ£ŸÖÿ´ŸÑÿ© ÿ≥ÿ±Ÿäÿπÿ©",
        "clear_chat": "üßπ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©",
        "features_title": "‚ÑπÔ∏è ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™",
        
        # Stats
        "total_agencies": "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™",
        "authorized": "ÿßŸÑŸÖÿπÿ™ŸÖÿØÿ©",
        "countries": "ÿßŸÑÿØŸàŸÑ",
        "cities": "ÿßŸÑŸÖÿØŸÜ",
        
        # Examples
        "ex_all_auth": "üîç ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑŸÖÿπÿ™ŸÖÿØÿ©",
        "ex_all_auth_q": "ÿ£ÿ∏Ÿáÿ± ŸÑŸä ÿ¨ŸÖŸäÿπ ÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑÿ≠ÿ¨ ÿßŸÑŸÖÿπÿ™ŸÖÿØÿ©",
        "ex_saudi": "üá∏üá¶ ÿ¥ÿ±ŸÉÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©",
        "ex_saudi_q": "ÿßÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ŸÅŸä ÿßŸÑŸÖŸÖŸÑŸÉÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©",
        "ex_by_country": "üìä ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿØŸàŸÑÿ©",
        "ex_by_country_q": "ŸÉŸÖ ÿπÿØÿØ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ŸÅŸä ŸÉŸÑ ÿØŸàŸÑÿ©ÿü",
        "ex_emails": "üìß ÿ¥ÿ±ŸÉÿßÿ™ ŸÑÿØŸäŸáÿß ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
        "ex_emails_q": "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑÿØŸäŸáÿß ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
        
        # Features
        "feat_ai": "ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä",
        "feat_ai_desc": "ÿßÿ≥ÿ™ÿπŸÑÿßŸÖÿßÿ™ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ∑ÿ®ŸäÿπŸäÿ©",
        "feat_multilingual": "ŸÖÿ™ÿπÿØÿØ ÿßŸÑŸÑÿ∫ÿßÿ™",
        "feat_multilingual_desc": "ÿØÿπŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸàÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©",
        "feat_viz": "ÿ™ÿµŸàÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
        "feat_viz_desc": "ÿ¨ÿØÿßŸàŸÑ ÿ™ŸÅÿßÿπŸÑŸäÿ©",
        "feat_export": "ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨",
        "feat_export_desc": "ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿµŸäÿ∫ÿ© CSV",
        "feat_secure": "ÿ¢ŸÖŸÜ",
        "feat_secure_desc": "ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ Ÿáÿ¨ŸÖÿßÿ™ SQL",
        
        # Chat
        "welcome_msg": "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá! üåô\n\nÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ŸÖÿ≥ÿßÿπÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ¨ ÿßŸÑÿ∞ŸÉŸä. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü",
        "input_placeholder": "ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß... üí¨",
        "thinking": "ü§î ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÑŸäŸÑ ÿ≥ÿ§ÿßŸÑŸÉ...",
        "searching": "üîç ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...",
        "generating_sql": "üß† ÿ¨ÿßÿ±Ÿç ÿ•ŸÜÿ¥ÿßÿ° ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ SQL...",
        "executing_query": "üíæ ÿ¨ÿßÿ±Ÿç ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿßÿ≥ÿ™ÿπŸÑÿßŸÖ...",
        "found_results": "‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ {count} ŸÜÿ™Ÿäÿ¨ÿ©",
        "sql_generated": "‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ SQL",
        "query_failed": "‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ≥ÿ™ÿπŸÑÿßŸÖ",
        
        # Results
        "results_badge": "üìä {count} ŸÜÿ™Ÿäÿ¨ÿ©",
        "columns_badge": "‚úÖ {count} ÿπŸÖŸàÿØ",
        "authorized_badge": "üîí {count} ŸÖÿπÿ™ŸÖÿØÿ©",
        "download_csv": "üì• ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ (CSV)",
        "view_sql": "üîç ÿπÿ±ÿ∂ ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ SQL",
        "executed_caption": "ÿ™ŸÖ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ‚Ä¢ {count} ÿµŸÅ ÿ™ŸÖ ÿ•ÿ±ÿ¨ÿßÿπŸá",
        
        # Messages
        "greeting": "ŸàÿπŸÑŸäŸÉŸÖ ÿßŸÑÿ≥ŸÑÿßŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá! üåô\n\nÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸáÿå ÿ£ŸÜÿß ÿ®ÿÆŸäÿ±! ÿ£ŸÜÿß ŸáŸÜÿß ŸÑŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑÿ≠ÿ¨. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉÿü",
        "no_results": "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨. ÿ≠ÿßŸàŸÑ ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ£Ÿà ÿ™Ÿàÿ≥Ÿäÿπ ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ®ÿ≠ÿ´.",
        "sql_error": "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ÿ≠ÿßŸàŸÑ ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ© ÿ≥ÿ§ÿßŸÑŸÉ.",
        "intent_error": "‚ö†Ô∏è ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑŸÜŸäÿ©",
        "general_error": "ÿπÿ∞ÿ±ÿßŸãÿå Ÿàÿßÿ¨Ÿáÿ™ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©.",
        "hint_rephrase": "üí° ÿ≠ÿßŸàŸÑ ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ© ÿ≥ÿ§ÿßŸÑŸÉ ÿ£Ÿà ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿßÿ™ ŸÖŸÅÿ™ÿßÿ≠Ÿäÿ© ŸÖÿÆÿ™ŸÑŸÅÿ©",
        "no_sql": "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸàŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ÿ•ŸÑŸâ ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ SQL ÿ¢ŸÖŸÜ. ÿ≠ÿßŸàŸÑ ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ≥ÿ§ÿßŸÑ.",
        
        # Voice
        "voice_title": "üé§ ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿµŸàÿ™",
        "voice_instructions": "ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ Ÿàÿ™ÿ≠ÿØÿ´ ÿ®ÿ≥ÿ§ÿßŸÑŸÉ",
        "voice_listening": "üé§ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ... ÿ™ÿ≠ÿØÿ´ ÿßŸÑÿ¢ŸÜ",
        "voice_processing": "üîÑ ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿµŸàÿ™ŸÉ...",
        "voice_success": "‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿ•ŸÑŸâ ŸÜÿµ",
        "voice_error": "‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿµŸàÿ™",
        "voice_start": "üé§ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ",
        "voice_stop": "‚èπÔ∏è ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ",
        "voice_back": "üìù ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿØÿ±ÿØÿ¥ÿ© ÿßŸÑŸÜÿµŸäÿ©",
    }
}

def t(key: str, lang: str = "English", **kwargs) -> str:
    """Get translation for key in specified new_language with optional formatting"""
    text = TRANSLATIONS.get(lang, TRANSLATIONS["English"]).get(key, key)
    if kwargs:
        return text.format(**kwargs)
    return text

def get_current_time() -> float:
    """Get current timestamp in Riyadh timezone"""
    riyadh_tz = pytz.timezone('Asia/Riyadh')
    return datetime.now(riyadh_tz).timestamp()

def format_time(timestamp: float) -> str:
    """Format timestamp to readable time in Riyadh timezone"""
    riyadh_tz = pytz.timezone('Asia/Riyadh')
    dt = datetime.fromtimestamp(timestamp, riyadh_tz)
    return dt.strftime("%I:%M %p")

# -----------------------------
# Page Configuration
# -----------------------------
st.set_page_config(
    page_title="üïã Hajj Chatbot",
    page_icon="üïã",
    layout="wide",
    initial_sidebar_state="expanded"
)

# -----------------------------
# Custom CSS
# -----------------------------
st.markdown("""
<style>
    .main {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
    }
    
    .header-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .main-title {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
    }
    
    .chat-input-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 70%;
        background: white;
        border-radius: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        padding: 5px;
        z-index: 999;
    }
    
    .chat-input-container input {
        flex: 1;
        border: none;
        outline: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 16px;
    }
    
    .mic-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-left: 10px;
        font-size: 18px;
        transition: all 0.3s ease;
    }
    
    .mic-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .mic-button.recording {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .voice-interface {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 3rem;
        margin: 2rem auto;
        max-width: 800px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .voice-visualizer {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 2rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        animation: voicePulse 1.5s ease-in-out infinite;
    }
    
    .voice-visualizer.recording {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        animation: voicePulseRecording 0.8s ease-in-out infinite;
    }
    
    @keyframes voicePulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
        }
    }
    
    @keyframes voicePulseRecording {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 0 25px rgba(255, 107, 107, 0);
        }
    }
    
    .voice-text {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin: 1rem 0;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }
</style>
""", unsafe_allow_html=True)

# -----------------------------
# Utility Functions
# -----------------------------
def sanitize_sql(sql_query: str) -> Optional[str]:
    """Reject dangerous queries and ensure SELECT only"""
    if not sql_query:
        return None
    dangerous = ['DROP', 'DELETE', 'INSERT', 'UPDATE', 'ALTER', 'CREATE', 'EXEC', 'EXECUTE', 'TRUNCATE']
    upper = sql_query.upper()
    for kw in dangerous:
        if kw in upper:
            return None
    if not sql_query.strip().upper().startswith("SELECT"):
        return None
    return sql_query.strip().rstrip(';')

def extract_sql_from_response(response_text: str) -> Optional[str]:
    """Extract SQL query from LLM response"""
    if not response_text:
        return None
    
    # Try code blocks first
    code_block_pattern = r'```(?:sql)?\s*(SELECT[\s\S]*?)```'
    match = re.search(code_block_pattern, response_text, re.IGNORECASE)
    if match:
        return match.group(1).strip().rstrip(';')
    
    # Try plain SELECT statement
    select_pattern = r'(SELECT\s+.*?(?:;|$))'
    match = re.search(select_pattern, response_text, re.IGNORECASE | re.DOTALL)
    if match:
        return match.group(1).strip().rstrip(';')
    
    if "NO_SQL" in response_text:
        return "NO_SQL"
    
    return None

# -----------------------------
# Database & OpenAI Setup
# -----------------------------
@st.cache_resource
def get_database_engine():
    """Initialize database engine"""
    try:
        return create_engine("sqlite:///hajj_companies.db")
    except Exception as e:
        st.error(f"‚ùå Database connection failed: {e}")
        st.stop()

engine = get_database_engine()

@st.cache_resource
def get_openai_client():
    """Initialize OpenAI client"""
    api_key = st.secrets.get("key", None)
    if not api_key:
        st.warning("‚ö†Ô∏è OpenAI API key missing in Streamlit secrets")
        st.stop()
    return OpenAI(api_key=api_key)

client = get_openai_client()

@st.cache_data(ttl=300)
def get_db_stats():
    """Fetch database statistics"""
    try:
        with engine.connect() as conn:
            return {
                'total': pd.read_sql(text("SELECT COUNT(*) as count FROM agencies"), conn).iloc[0]['count'],
                'authorized': pd.read_sql(text("SELECT COUNT(*) as count FROM agencies WHERE is_authorized = 'Yes'"), conn).iloc[0]['count'],
                'countries': pd.read_sql(text("SELECT COUNT(DISTINCT country) as count FROM agencies"), conn).iloc[0]['count'],
                'cities': pd.read_sql(text("SELECT COUNT(DISTINCT city) as count FROM agencies"), conn).iloc[0]['count']
            }
    except:
        return {'total': 0, 'authorized': 0, 'countries': 0, 'cities': 0}

# -----------------------------
# Session State Initialization
# -----------------------------
if "new_language" not in st.session_state:
    st.session_state.new_language = "English"
if "chat_memory" not in st.session_state:
    st.session_state.chat_memory = []
if "last_result_df" not in st.session_state:
    st.session_state.last_result_df = None
if "selected_question" not in st.session_state:
    st.session_state.selected_question = None
if "show_voice_interface" not in st.session_state:
    st.session_state.show_voice_interface = False
if "is_recording" not in st.session_state:
    st.session_state.is_recording = False
if "transcribed_text" not in st.session_state:
    st.session_state.transcribed_text = ""

# -----------------------------
# Sidebar
# -----------------------------
with st.sidebar:
    st.markdown(f"<h2 style='text-align: center; color: white; margin-bottom: 0;'>{t('assistant_title', st.session_state.new_language)}</h2>", unsafe_allow_html=True)
    st.markdown(f"<p style='text-align: center; color: rgba(255,255,255,0.7); font-size: 0.9rem;'>{t('assistant_subtitle', st.session_state.new_language)}</p>", unsafe_allow_html=True)
    st.markdown("---")

    # Language Toggle
    st.markdown(f"<h3>{t('language_title', st.session_state.new_language)}</h3>", unsafe_allow_html=True)
    language_choice = st.radio(
        "",
        ["English üá¨üáß", "ÿßŸÑÿπÿ±ÿ®Ÿäÿ© üá∏üá¶"],
        index=0 if st.session_state.new_language == "English" else 1,
        horizontal=True,
        label_visibility="collapsed",
        key="lang_radio"
    )
    
    # Handle language change
    new_language = "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©" if "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©" in language_choice else "English"
    if new_language != st.session_state.new_language:
        st.session_state.new_language = new_language
        if len(st.session_state.chat_memory) == 0:
            st.session_state.chat_memory = [{
                "role": "assistant",
                "content": t("welcome_msg", st.session_state.new_language),
                "timestamp": get_current_time()
            }]
        st.rerun()

    st.markdown("---")
    
    # Database Statistics
    st.markdown(f"<h3>{t('stats_title', st.session_state.new_language)}</h3>", unsafe_allow_html=True)
    stats = get_db_stats()
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric(t("total_agencies", st.session_state.new_language), f"{stats['total']:,}")
        st.metric(t("authorized", st.session_state.new_language), f"{stats['authorized']:,}")
    with col2:
        st.metric(t("countries", st.session_state.new_language), stats['countries'])
        st.metric(t("cities", st.session_state.new_language), stats['cities'])

    st.markdown("---")
    
    # Example Questions
    st.markdown(f"<h3>{t('examples_title', st.session_state.new_language)}</h3>", unsafe_allow_html=True)
    example_questions = [
        ("ex_all_auth", "ex_all_auth_q"),
        ("ex_saudi", "ex_saudi_q"),
        ("ex_by_country", "ex_by_country_q"),
        ("ex_emails", "ex_emails_q"),
    ]
    
    for i, (display_key, question_key) in enumerate(example_questions):
        if st.button(t(display_key, st.session_state.new_language), key=f"example_{i}", use_container_width=True):
            st.session_state.selected_question = t(question_key, st.session_state.new_language)

    st.markdown("---")
    
    # Clear Chat Button
    if st.button(t("clear_chat", st.session_state.new_language), use_container_width=True, type="primary"):
        st.session_state.chat_memory = [{
            "role": "assistant",
            "content": t("welcome_msg", st.session_state.new_language),
            "timestamp": get_current_time()
        }]
        st.session_state.last_result_df = None
        st.rerun()

# -----------------------------
# Main Header
# -----------------------------
st.markdown(f"""
<div class="header-container{' rtl' if st.session_state.new_language == 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' else ''}">
    <h1>
        üïã <span class="main-title">{t('main_title', st.session_state.new_language)}</span>
    </h1>
    <p class="subtitle">{t('subtitle', st.session_state.new_language)}</p>
</div>
""", unsafe_allow_html=True)

# -----------------------------
# Initialize Session State
# -----------------------------
if "chat_memory" not in st.session_state:
    st.session_state.chat_memory = [{
        "role": "assistant",
        "content": t("welcome_msg", st.session_state.new_language),
        "timestamp": get_current_time()
    }]

# -----------------------------
# Display Chat History
# -----------------------------
for idx, msg in enumerate(st.session_state.chat_memory):
    role = msg.get("role", "assistant")
    avatar = "üïã" if role == "assistant" else "üë§"
    with st.chat_message(role, avatar=avatar):
        st.markdown(msg.get("content", ""))
        if msg.get("timestamp"):
            st.markdown(
                f"<div style='color: #999; font-size: 0.85rem; margin-top: 0.5rem;'>üïê {datetime.fromtimestamp(msg['timestamp']).strftime('%I:%M %p')}</div>",
                unsafe_allow_html=True
            )

        if "dataframe" in msg and msg["dataframe"] is not None:
            df = msg["dataframe"]
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("Results", len(df))
            with col2:
                st.metric("Columns", len(df.columns))
            with col3:
                if "is_authorized" in df.columns:
                    auth_count = len(df[df["is_authorized"] == "Yes"])
                    st.metric("Authorized", auth_count)

            st.dataframe(df, use_container_width=True, height=300)

            csv = df.to_csv(index=False).encode("utf-8")
            st.download_button(
                label="üì• Download CSV",
                data=csv,
                file_name=f"hajj_data_{int(msg['timestamp'])}.csv",
                mime="text/csv",
                key=f"download_{idx}"
            )

# -----------------------------
# Voice Recording JavaScript
# -----------------------------
voice_js = """
<script>
class VoiceRecorder {
    constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.isRecording = false;
    }

    async startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.mediaRecorder = new MediaRecorder(stream);
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
                this.audioChunks.push(event.data);
            };
            
            this.mediaRecorder.onstop = () => {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                this.sendAudioToServer(audioBlob);
            };
            
            this.mediaRecorder.start();
            this.isRecording = true;
            return true;
        } catch (error) {
            console.error('Error starting recording:', error);
            return false;
        }
    }

    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            
            // Stop all audio tracks
            this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
    }

    sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        
        // Send to Streamlit
        const xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.onload = function() {
            if (xhr.status === 200) {
                window.location.reload();
            }
        };
        xhr.send(formData);
    }
}

// Initialize voice recorder
window.voiceRecorder = new VoiceRecorder();

// Handle recording buttons
function startRecording() {
    const success = window.voiceRecorder.startRecording();
    if (success) {
        document.getElementById('recording-status').innerText = 'üé§ Listening... Speak now';
        document.getElementById('voice-visualizer').classList.add('recording');
        document.getElementById('start-record').style.display = 'none';
        document.getElementById('stop-record').style.display = 'block';
    }
}

function stopRecording() {
    window.voiceRecorder.stopRecording();
    document.getElementById('recording-status').innerText = 'üîÑ Processing your voice...';
    document.getElementById('voice-visualizer').classList.remove('recording');
    document.getElementById('start-record').style.display = 'block';
    document.getElementById('stop-record').style.display = 'none';
}
</script>
"""

# -----------------------------
# Voice Interface
# -----------------------------
if st.session_state.show_voice_interface:
    # Inject JavaScript
    st.components.v1.html(voice_js, height=0)
    
    st.markdown("<div class='voice-interface'>", unsafe_allow_html=True)
    
    # Back button
    if st.button("‚Üê " + t("voice_back", st.session_state.new_language), key="back_button"):
        st.session_state.show_voice_interface = False
        st.rerun()
    
    st.markdown(f"<h2 style='color: #667eea; margin-bottom: 1rem;'>{t('voice_title', st.session_state.new_language)}</h2>", unsafe_allow_html=True)
    
    # Voice visualizer
    visualizer_class = "voice-visualizer recording" if st.session_state.is_recording else "voice-visualizer"
    st.markdown(f"""
    <div id="voice-visualizer" class="{visualizer_class}">
        <div style='font-size: 4rem;'>üé§</div>
    </div>
    """, unsafe_allow_html=True)
    
    # Recording status
    status_text = t("voice_listening", st.session_state.new_language) if st.session_state.is_recording else t("voice_instructions", st.session_state.new_language)
    st.markdown(f"<div id='recording-status' class='voice-text'>{status_text}</div>", unsafe_allow_html=True)
    
    # Show transcribed text if available
    if st.session_state.transcribed_text:
        st.success(f"üéØ {t('voice_success', st.session_state.new_language)}: {st.session_state.transcribed_text}")
        
        # Process the transcribed text
        if st.button("üîç Search with this text", type="primary", use_container_width=True):
            st.session_state.selected_question = st.session_state.transcribed_text
            st.session_state.show_voice_interface = False
            st.session_state.transcribed_text = ""
            st.rerun()
    
    # Recording controls
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        if not st.session_state.is_recording:
            if st.button("üé§ " + t("voice_start", st.session_state.new_language), 
                        key="start-record", use_container_width=True, type="primary"):
                st.session_state.is_recording = True
                st.rerun()
        else:
            if st.button("‚èπÔ∏è " + t("voice_stop", st.session_state.new_language), 
                        key="stop-record", use_container_width=True):
                st.session_state.is_recording = False
                # Simulate voice processing (in real app, this would use actual speech-to-text)
                st.session_state.transcribed_text = "Show me authorized Hajj companies in Mecca"
                st.rerun()
    
    st.markdown("</div>", unsafe_allow_html=True)

else:
    # -----------------------------
    # Main Chat Interface
    # -----------------------------
    
    # Custom chat input with microphone
    st.markdown("""
    <div class='chat-input-container'>
        <div style='flex: 1;'>
    """, unsafe_allow_html=True)
    
    # Chat input
    user_input = st.chat_input(
        t("input_placeholder", st.session_state.new_language),
        key="chat_input"
    )
    
    st.markdown("</div>", unsafe_allow_html=True)
    
    # Microphone button
    st.markdown("""
        <div style='margin-left: 10px;'>
    """, unsafe_allow_html=True)
    
    if st.button("üé§", key="mic_button", help="Voice input"):
        st.session_state.show_voice_interface = True
        st.rerun()
    
    st.markdown("</div></div>", unsafe_allow_html=True)

    # Process user input
    if user_input or st.session_state.selected_question:
        question = st.session_state.selected_question if st.session_state.selected_question else user_input
        st.session_state.selected_question = None

        # Add user message to chat
        st.session_state.chat_memory.append({
            "role": "user",
            "content": question,
            "timestamp": get_current_time()
        })

        # Display user message immediately
        with st.chat_message("user", avatar="üë§"):
            st.markdown(question)
            st.markdown(f"<div style='color: #999; font-size: 0.85rem; margin-top: 0.5rem;'>üïê {format_time(get_current_time())}</div>", unsafe_allow_html=True)

        # Process the question
        with st.chat_message("assistant", avatar="üïã"):
            with st.spinner(t("thinking", st.session_state.new_language)):
                try:
                    # Generate SQL query using OpenAI
                    prompt = f"""
                    Generate a SQL query for this question about Hajj companies: "{question}"
                    
                    Database table: agencies
                    Columns: id, company_name, country, city, is_authorized, email, phone, address
                    
                    Return ONLY the SQL query, no explanations.
                    Use SELECT statements only.
                    Include LIMIT 100 if no specific limit is mentioned.
                    """
                    
                    response = client.chat.completions.create(
                        model="gpt-3.5-turbo",
                        messages=[
                            {"role": "system", "content": "You are a SQL query generator. Return only SQL queries."},
                            {"role": "user", "content": prompt}
                        ],
                        temperature=0.1,
                        max_tokens=200
                    )
                    
                    sql_query = extract_sql_from_response(response.choices[0].message.content)
                    
                    if not sql_query or sql_query == "NO_SQL":
                        # Fallback queries
                        if "authorized" in question.lower():
                            sql_query = "SELECT * FROM agencies WHERE is_authorized = 'Yes' LIMIT 100"
                        elif "saudi" in question.lower() or "ksa" in question.lower():
                            sql_query = "SELECT * FROM agencies WHERE country LIKE '%Saudi%' LIMIT 100"
                        else:
                            sql_query = "SELECT * FROM agencies LIMIT 100"
                    
                    # Sanitize and execute query
                    safe_sql = sanitize_sql(sql_query)
                    if safe_sql:
                        try:
                            with engine.connect() as conn:
                                df = pd.read_sql(text(safe_sql), conn)
                            
                            if df.empty:
                                st.markdown(t("no_results", st.session_state.new_language))
                            else:
                                st.markdown(f"**{t('found_results', st.session_state.new_language, count=len(df))}**")
                                
                                # Display results
                                col1, col2, col3 = st.columns(3)
                                with col1:
                                    st.metric("Results", len(df))
                                with col2:
                                    st.metric("Columns", len(df.columns))
                                with col3:
                                    if "is_authorized" in df.columns:
                                        auth_count = len(df[df["is_authorized"] == "Yes"])
                                        st.metric("Authorized", auth_count)

                                st.dataframe(df, use_container_width=True, height=300)
                                
                                # Download button
                                csv = df.to_csv(index=False).encode("utf-8")
                                st.download_button(
                                    label="üì• Download CSV",
                                    data=csv,
                                    file_name=f"hajj_data_{int(datetime.now().timestamp())}.csv",
                                    mime="text/csv"
                                )
                                
                                # Store in session state
                                st.session_state.last_result_df = df
                                st.session_state.chat_memory.append({
                                    "role": "assistant",
                                    "content": t("found_results", st.session_state.new_language, count=len(df)),
                                    "dataframe": df,
                                    "timestamp": get_current_time()
                                })
                        
                        except Exception as db_error:
                            st.markdown(f"‚ùå {t('query_failed', st.session_state.new_language)}")
                            st.markdown(f"`{str(db_error)}`")
                    else:
                        st.markdown(t("no_sql", st.session_state.new_language))
                
                except Exception as e:
                    st.markdown(f"‚ùå {t('general_error', st.session_state.new_language)}")
                    st.markdown(f"`{str(e)}`")

        st.rerun()
